#!/usr/bin/env Rscript


library(argparse)

usage <- function() {
  usage.text <- '\nUsage: script.R --summary_file <path to the summary file (consensus sequences qc summary) generated by summarize_qc_csv.py> --metadata <path to the metadata file having the columns: Ct and sample_name> --prefix <prefix to the output filename> --outdir <path to the output directory name>\n\n'
  return(usage.text)
}

parser <- ArgumentParser()
parser$add_argument("--summary", default=NULL, help="path to the summary file (consensus sequences qc summary) generated by summarize_qc_csv.py")
parser$add_argument("--metadata", default=NULL, help="path to the metadata file having the columns: Ct and sample_name")
parser$add_argument("--prefix", default="allsamples", help="prefix to the output filename")
parser$add_argument("--outdir", default="./", help="output directory path")
args <- parser$parse_args()

###########################################
#######        load packages        #######
###########################################

library(ggplot2)
library(ggforce)
library(hrbrthemes)
library(scales)
library(viridis)
library(reshape2)
library(dplyr)
library(cowplot)

###########################################
#######           checks           #######
###########################################

if (is.null(args$summary)) {
  parser$print_help()
  stop("Please provide the comma-separated values file generated by summarize_qc_csv.py", call.=FALSE)
}
if (!all(file.exists(args$summary))) {
  parser$print_help()
  stop(paste("The following summary file don't exist:", 
             paste(args$summary, sep='', collapse=' '), sep=' '), call.=FALSE)
} else {
  summary <- args$summary
}

outdir <- args$outdir
if (tail(strsplit(outdir,"")[[1]],1)!="/") {
  outdir <- paste(outdir,"/",sep='')
}
if (!file.exists(outdir)) {
  dir.create(outdir, recursive=TRUE)
}

prefix <- args$prefix


if (is.null(args$metadata)) {
  metadata = data.frame(sample_name=character(), Ct=double())
} else {
  # read the metadata table (having Ct values)
  metadata.raw <- read.csv(args$metadata, header=T, sep=",")
  metadata = subset(metadata.raw, Ct != "NA")
  metadata$Ct = as.numeric(as.character(metadata$Ct))
}

print(metadata)

###########################################
#######      read input files       #######
###########################################

# read the consensus qc summary file
cons <- read.csv(file = summary, sep = ",", header = TRUE)
print(cons)

# merge dataframes
data <- merge(cons, metadata, by="sample_name")
print(data)

d <- data %>% 
  arrange(desc(Ct)) %>% 
  mutate(sample_name=factor(sample_name, sample_name)) %>% dplyr::rename(Sample="sample_name")


plt <- ggplot(d, aes(x = Ct, y = pct_covered_bases)) + 
  geom_point(aes(fill=Sample), stat = "identity", shape = 21, size=5) +
  scale_y_continuous(limits=c(0,100),breaks=c(0,25,50,75,100)) +
  scale_color_viridis(discrete = TRUE, option = "B")+
  scale_fill_viridis(discrete = TRUE) +
  theme_classic() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 18),
        legend.text = element_text(size = 11)) +
  labs(
    x="RT-qPCR Cycle threshold (Ct)",
    y=paste("RVFV genome coverage (%)", sep = " ")
  ) 
print(plt)

ggsave(filename = paste(outdir, prefix, ".coverage.vs.ct.pdf", sep = ""), plt, 
       dpi = 300,
       units = "in", device = "pdf")